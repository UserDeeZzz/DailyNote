### 事务

事务就是要保证一组数据库操作，要么全部成功，要么全部失败

事务支持是在引擎层`InnoDB`实现的

### 隔离性与隔离级别

ACID 原子 一致 隔离 持久

|                | 脏读 | 不可重复读 | 幻读 | 加锁 |
| -------------- | ---- | ---------- | ---- | ---- |
| 读未提交       | 1    |            |      |      |
| 读提交         |      | 1          |      |      |
| 可重复读(默认) |      |            | 1    |      |
| 串行化         |      |            |      | 1    |

![](https://static001.geekbang.org/resource/image/7d/f8/7dea45932a6b722eb069d2264d0066f8.png)

我们来看看在不同的隔离级别下，事务A会有哪些不同的返回结果，也就是图里面V1、V2、V3的返回值分别是什么。

- 若隔离级别是“读未提交”， 则V1的值就是2。这时候事务B虽然还没有提交，但是结果已经被A看到了。因此，V2、V3也都是2。
- 若隔离级别是“读提交”，则V1是1，V2的值是2。事务B的更新在提交后才能被A看到。所以， V3的值也是2。
- 若隔离级别是“可重复读”，则V1、V2是1，V3是2。之所以V2还是1，遵循的就是这个要求：事务在执行期间看到的数据前后必须是一致的。
- 若隔离级别是“串行化”，则在事务B执行“将1改成2”的时候，会被锁住。直到事务A提交后，事务B才可以继续执行。所以从A的角度看， V1、V2值是1，V3的值是2。

### 事务隔离的实现(`MVCC`)

不同时刻启动的事务会有不同的视图

同一条记录在系统中可以存在多个版本

 每行记录有2个隐藏列`DATA_TRX_ID` 、 `DATA_ROLL_PTR`  代表事务id和回滚日志指针

将当前值依次执行回滚操作得到

![](https://static001.geekbang.org/resource/image/d9/ee/d9c313809e5ac148fc39feff532f0fee.png)

```mysql
set autocommit=1 # 开启事务
commit # 提交
rollback # 回滚
```

